{{HowTo}}{{Subversion}}
{{Bouygues}}
[[Category:HowTo|Subversion]]
[[Category:Subversion|Installation]]
[[Category:Bouygues SAS]]
[[Category:Bouygues EZP]]

__TOC__

== Description ==

[http://fsvs.tigris.org/ FSVS] est un système de gestion de révision avec des fonctionnalités de sauvegarde/restauration, utilisable sur une arborescence disque ou un système de fichiers entier, et qui utilise [http://subversion.tigris.org/ Subversion] comme serveur de stockage.

FSVS est une sorte de ''tar'' ou ''rsync'' avec une gestion de versions intégrée. Le nom signifie  “''Fast System VerSioning''”et se prononce ''fisvis''.

Ce document décrit la configuration et l'utilisateur de FSVS au quotidien.

'''Pour une description de l'architecture FSVS chez Easynet et la procédure d'installation, reportez-vous au document [[FSVS_Installation]].'''

'''Note''' : La connaissance et la compréhension des concepts de base de [http://subversion.tigris.org Subversion] est nécessaire à la bonne utilisation de ce document.

=== Documentation ===

La section '''[[FSVS_Configuration_et_Utilisation#Utilisation_de_FSVS|Utilisation de FSVS]]''' décrit les principales commandes pour une utilisation au jour le jour. Pour une utilisation plus poussée, et pour avoir le détail de chaque commande, merci de lire la documentation officielle :

* Le programme ''fsvs'' est documenté dans une page ''man'' : « <tt>fsvs(1)</tt> »
* Les options du programme sont documentées dans une page ''man'' : « <tt>fsvs-options(5)</tt> »
* Les pages principales de la documentation utilisateur sont ici :
** [http://doc.fsvs-software.org/doxygen-gif/group__userdoc.html Page principale]
** [http://doc.fsvs-software.org/doxygen-gif/group__cmds.html Paramètres de la ligne de commande]
** [http://doc.fsvs-software.org/doxygen-gif/group__ignpat.html Format de la liste ''ignore'']
** [http://doc.fsvs-software.org/doxygen-gif/group__url__format.html Format des URLs]
** [http://doc.fsvs-software.org/doxygen-gif/group__howto.html Liste des HOWTOs]
** [http://doc.fsvs-software.org/doxygen-gif/group__howto__master__local.html Utilisation de référentiels multiples]
* D'autres liens vers la documentation de FSVS sont donnés à la fin de la [[FSVS_Installation#R.C3.A9f.C3.A9rences|documentation d'installation]].

== Arborescence du référentiel FSVS/Subversion ==

La configuration utilisée est inspirée des exemples donnés sur le site web de FSVS : http://doc.fsvs-software.org/doxygen-gif/group__howto__master__local.html

L'arborescence du référentiel Bouygues Telecom / CMSINT est la suivante :

 test/
 system/
 system/prod/
 system/prod/back/
 system/prod/back/trunk/
 system/prod/machines/
 system/prod/machines/ezpstatlog/
 system/prod/machines/ezpstatlog/trunk/
 system/prod/machines/ezpstatlog/trunk/etc/
 system/prod/front/
 system/prod/front/trunk/
 system/preprod/
 system/preprod/back/
 system/preprod/back/trunk/
 system/preprod/back/trunk/etc/
 system/preprod/mysql-cl/
 system/preprod/mysql-cl/trunk/
 system/preprod/mysql-cl/trunk/etc/
 system/preprod/mysql-co/
 system/preprod/mysql-co/trunk/
 system/preprod/mysql-co/trunk/etc/
 system/preprod/machines/
 system/preprod/machines/frontezp-pp1/
 system/preprod/machines/frontezp-pp1/trunk/
 system/preprod/machines/frontezp-pp1/trunk/etc/
 system/preprod/machines/frontezp-pp2/
 system/preprod/machines/frontezp-pp2/trunk/
 system/preprod/machines/frontezp-pp2/trunk/etc/
 system/preprod/machines/frontezp-pp2/trunk/etc/fsvs/
 system/preprod/machines/backezp-pp1/
 system/preprod/machines/backezp-pp1/trunk/
 system/preprod/machines/backezp-pp1/trunk/etc/
 system/preprod/machines/backezp-pp2/
 system/preprod/machines/backezp-pp2/trunk/
 system/preprod/machines/backezp-pp2/trunk/etc/
 system/preprod/front/
 system/preprod/front/trunk/
 system/preprod/front/trunk/etc/
 cmsint/
 cmsint/prod/
 cmsint/prod/back/
 cmsint/prod/back/trunk/
 cmsint/prod/back/trunk/ezpublish/
 cmsint/prod/front/
 cmsint/prod/front/trunk/
 cmsint/prod/front/trunk/ezpublish/
 cmsint/preprod/
 cmsint/preprod/back/
 cmsint/preprod/back/trunk/
 cmsint/preprod/back/trunk/ezpublish/
 cmsint/preprod/front/
 cmsint/preprod/front/trunk/
 cmsint/preprod/front/trunk/ezpublish/

=== Description détaillée de l'arborescence ===

==== Branches principales ====

A la racine, il y a 3 branches principales :

; test : Sert uniquement aux tests
; system : Cette branche contient les répertoires système sous contrôle FSVS, par exemple « <tt>/etc</tt> »
; cmsint : Cette branche contient l'applicatif EzPublish / CMSINT

==== Branches Prod et Preprod ====

Ensuite il y a 2 branches distinguant les serveurs de Production de ceux que Préproduction :

; prod : Production
; preprod : Préproduction

==== Branches «génériques » pour les cluster serveurs ====

Pour les serveurs en « cluster », il y a une seule branche commune, car normalement ''le contenu du répertoire est identique entre tous les serveurs''.

; back : Contenu des serveurs de Backoffice
; front : Contenu des serveurs de Frontoffice

==== Branches machines ====

Il y a, à côté des branches génériques, des branches nominatives pour :
* toutes les machines qui sont uniques (par exemple EzpStatLog)
* les contenus uniques de serveurs en cluster (par exemple le répertoire « <tt>/etc/sysconfig/networking</tt> » des serveurs FO de Preprod est '''unique''' à chaque serveur, car il contient l'adresse IP, le nom de la machine, etc. Alors que « <tt>/etc</tt> » est quant à lui mutualisé en quasi-totalité dans la branche générique.

=== Configuration initiale du référentiel ===

Pour créer l'arborescence sur le serveur Subversion, il faut utiliser <tt>SVN</tt> localement.

Pour créer les multiples arborescences, le plus simple est de faire un « ''checkout'' » dans un répertoire temporaire de tout le référentiel Subversion (ou d'une branche), puis de créer les répertoires avec « <tt>svn mkdir</tt> ». Ensuite on fait un seul « ''commit'' » global.

==== Exemple 1 ====

<pre>
export EDITOR=vim
export SVN=svn://10.10.2.44/
mkdir /tmp/fsvs-farzad
cd /tmp/fsvs-farzad
svn checkout $SVN/cmsint
cd cmsint
mkdir -p prod/front/trunk/ezpublish
mkdir -p prod/back/trunk/ezpublish
mkdir -p preprod/back/trunk/ezpublish
mkdir -p preprod/front/trunk/ezpublish
svn add prod preprod
svn commit --username=farzad.farid -m "Creation de l'arborescence /cmsint"
cd ~
rm -rf /tmp/fsvs-farzad
</pre>

==== Exemple 2 ====

Ici, nous créons les arborescences « <tt>/etc</tt> » pour tous les serveurs CMSINT de production, en Production.

<pre>
export EDITOR=vim
export SVN=svn://10.10.2.44/

mkdir /tmp/fsvs-farzad
cd /tmp/fsvs-farzad
svn checkout $SVN/system/prod
cd prod
for m in frontezp-p1 frontezp-p2 frontezp-p3 frontezp-p4 backezp-p1 backezp-p2 \
    mysqlezpp-co1 mysqlezpp-co2 mysqlezpp-col1 mysqlezpp-col2 mysqlezpp-col3 \
    mysqlezpp-cl1 mysqlezpp-cl2 ezpstatlog ; do 
  mkdir -p -v machines/$m/trunk/etc
  svn add machines/$m
done
svn commit --username=farzad.farid -m "Création de l'arborescence '/system/prod/machines/*/trunk/etc' de Production"
cd ~
rm -rf /tmp/fsvs-farzad
</pre>

== Configuration de FSVS sur une machine cliente ==

L'installation initiale de FSVS sur un serveur dont on veut versionner des répertoires est décrite [[FSVS_Installation#Configuration_de_FSVS_sur_une_machine_cliente|dans le document d'installation]].

== Utilisation de FSVS ==

Cette section décrit l'utilisation quotidienne de FSVS.

Pour l'outil en ligne de commande <tt>fsvs</tt>, référez vous à la [[FSVS_Configuration_et_Utilisation#Documentation|documentation officielle]] pour apprendre le fonctionnement de base.

=== Liste des arborescences spéciales plate-forme par plate-forme ===

Les répertoires "extension" et "settings" dans « <tt>/app/ezpublish</tt> » sont partagés
en NFS entre plusieurs serveurs. Par contre, ils ne sont présents que '''une seule fois''' dans FSVS.

Voici la liste de tous les emplacements, avec entre parenthèses le nom du serveur
sur lequel ce référentiel est monté :

* Plate-forme de Préproduction
** Frontaux
*** Il n'y a pas de répertoire "ezpublish-extension-settings" pour les frontaux car il est partagé en NFS avec le Backoffice.
** Backoffice
*** /cmsint/preprod/back/trunk/ezpublish-extension-settings (''backezp-pp1'')
* Plate-forme de Production
** Frontaux
*** /cmsint/prod/front/trunk/ezpublish-extension-settings (''frontezp-p1'')
** Backoffice
*** /cmsint/prod/back/trunk/ezpublish-extension-settings (''backezp-p1'')

'''Pour cette raison, en cas de mise à jour de CMSINT, il ne faut exécuter FSVS que sur les machines backezp-pp1, frontezp-p1 et backezp-p1. Si la mise à jour ne touche à aucun fichier en dehors des répertoires « extension x et « settings », il ne faut pas lancer FSVS sur backezp-p2, frontezp-p2, frontezp-p3, backezp-pp2, etc.'''

'''Note''' : En cas de modification de ce chapitre, il faut aussi mettre à jour le document http://10.10.2.44/viewvc/cmsint/LISEZMOI.

=== Consultation du référentiel ===

L'outil '''[http://viewvc.tigris.org ViewVC]''' fournit une interface web de consultation du référentiel FSVS/Subversion. Grâce à cet outil, il est possible de
consulter les répertoires CMSINT de tous les serveurs ainsi que l'historique de toutes les modifications.

==== Fonctionnalités fournies ====

* Accès en lecture seule au répertoire applicatif "/app/ezpublish"
* Accès aux serveurs de Production et Préproduction
* Possibilité de consulter l'historique des modifications
* Chaque modification commitée dans le référentiel contient la date et l'auteur de la modification
* Consultation de l'état d'un dossier ou fichier à une révision (et date) arbitraire dans le passé
* Possibilité de comparer 2 versions d'un fichier
* Génération automatique d'archives au format "tar.gz" de répertoires

==== Documentation de ViewVC ====

'''[http://10.10.2.44/viewvc/cmsint/LISEZMOI?view=markup Le mode d'emploi de ViewVC]''' est disponible dans ViewVC lui-même.

'''Note''' : Pour modifier ce document, utilisez la procédure décrite dans la [[FSVS_Installation#Comment_mettre_.C3.A0_jour_la_doc_ViewVC|documentation d'installation de FSVS]].

==== Utilisation ====

'''[http://10.10.2.44/viewvc/ L'interface de consultation ViewVC]''' est sur le serveur '''EzpStatLog'''.

Les mots de passe d'accès sont stocké dans '''Charly''', serveur '''EzpStatLog''', sous le nom d'application '''Apache'''. Chercher « ''FSVS / Subversion'' » dans le champ version pour trouver la bonne entrée.

=== Autocommit : Fonctionnement et consultation ===

==== Fonctionnement ====

Le paquet FSVS créé pour Easynet contient un script « <tt>/usr/sbin/fsvs-autocommit</tt> », ainsi qu'un fichier ''cron'', « <tt>/etc/cron.d/fsvs</tt> », qui en contrôle le lancement quotidien, vers 6 heures du matin.

Ce script fait un commit automatique de tous les changements de la veille, qui n'auraient pas été commités manuellement en journée. Il trouve automatiquement tous les répertoires racines sous contrôle de FSVS (ils sont décrits dans « <tt>/etc/fsvs</tt> »), et génère un journal complet de ses actions.

==== Consultation des logs ====

A la fin de son exécution, <tt>fsvs-autocommit</tt> envoie un message unique à '''syslog''' pour signaler le bon déroulement du script, ou au contraire une erreur. La priorité et le contenu de ce message sont :
; cron.notice : Aucune erreur ne s'est produite. Le message combien de fichiers/répertoires ont été auto-commités.
; cron.error : Un erreur s'est produite. Le message dit de consulter le log détaillé.

* '''Php-Syslog-NG''' étant installé sur un serveur central, http://10.10.2.44/php-syslog-ng/html dans le cas de Bouygues Telecom CMSINT, il suffit de consulter cette page chaque jour pour voir l'état du versionning.
* On peut aussi consulter directement [http://10.10.2.44/php-syslog-ng/html/index.php?table=logs&excludeHost=1&host2=&excludeProgram=0&program2=&program%5b%5d=fsvs&excludeFacility=1&excludePriority=1&date=&time=&date2=&time2=&limit=50&topx=10&orderby=host&order=DESC&msg1=&msg2=&msg3=&pageId=Search le compte-rendu des crons FSVS du matin].

En plus du message syslog, <tt>fsvs-autocommit</tt> écrit un journal complet dans le fichier local « <tt>/var/log/fsvs.log</tt> ». En cas de problème, il faut alors se connecter sur la machine, et de consulter ce fichier.

Voici un exemple d'affichage de Php-Syslog-NG :

[[Image:Php-Syslog-NG-FSVS.png]]

=== Principales commandes FSVS ===

Sauf indication contraire, toutes les commandes qui suivent doivent être exécutées avec un répertoire courant qui est versionné avec FSVS.

==== Affiche le status du répertoire courant ====

<pre>
# fsvs status -C
.m..     20215  X11/twm/menudefs.hook
.m..     23043  X11/twm/system.twmrc
.m..       dir  X11/twm
.m..       dir  dhcp3/dhclient-enter-hooks.d
.m..       dir  pam.d
.m..        67  resolv.conf
.mC.     11875  samba/smb.conf
.m..       dir  samba
.mC.       642  qt3/qt_plugins_3.3rc
.m..       dir  qt3
.mC.       789  vmware/vmnet8/dhcpd/dhcpd.leases
.m..       dir  vmware/vmnet8/dhcpd
.m..       dir  fsvs
.m..       dir  .
</pre>

* '''Il est conseillé de toujours exécuter <tt>fsvs status</tt> avec l'option <tt>-C</tt>'''

==== Affiche le status en excluant les modifications du répertoire "[/etc/]fsvs" ====

 cd /etc
 fsvs status | awk '$3 !~ /^fsvs/'

==== Affiche le log de révision pour le répertoire courant ====

 fsvs log [fichier ou répertoire]

En ajoutant l'option '''<tt>-v</tt>''', la commande affiche en plus la liste de tous les fichiers / répertoires concernés par chaque révision.

 fsvs log -v

==== Affiche les objets modifiés par une révision donnée ====

Soit '''N''' le numéro de révision.

 fsvs log -v -r N

==== Committer une arborescence dans un référentiel donné ====

{{:Bouygues/Modèle Cadre |
titre = Tous les répertoires versionnés ne sont pas dans le même référentiel |
couleur = #80FF00 |
couleurTitre = #00FF00 |
contenu = 
Par exemple, « <tt>/etc</tt> » et « <tt>/app/ezpublish</tt> » sont dans 2 référentiels disjoints. Par conséquent, si vous apportez des modifications dans ces deux arborescences, il faut faire au moins 2 commits :
* Un commit en se positionnant dans « <tt>/etc</tt> »
* Un commit en se positionnant dans « <tt>/app/ezpublish</tt> »
}}
===== Précautions à prendre avec certains référentiels =====

{{:Bouygues/Modèle Cadre |
titre = Attention aux répertoire gérés par plusieurs référentiels FSVS/SVN à la fois ! |
couleur = #FF8000 |
couleurTitre = #FF0000 |
contenu = 
Certains répertoires, comme « <tt>/app/ezpublish</tt> », utilisent plusieurs référentiels SVN à la fois. Dans ce cas,
le '''commit''' devra préciser dans quel référentiel il faut faire la mise à jour.
}}

Pour vérifier si l'on est dans un répertoire avec un référentiel multiple, taper la commande suivantes. S'il s'affiche une seule URL c'est un référentiel sinon, sinon il est multiple :
  fsvs urls

Par exemple, sur le serveur '''backezp-p1''' :

<pre>
[root@backezp-p1 ~]# cd /app/ezpublish
[root@backezp-p1 ezpublish]# fsvs urls
N:nfs,P:100,svn://10.10.2.44/cmsint/prod/back/trunk/ezpublish-extension-settings
N:base,P:200,svn://10.10.2.44/cmsint/prod/back/trunk/ezpublish
</pre>

Dans ce cas, il faut vérifier, par exemple avec la commande « <tt>fsvs info nom_fichier_ou_repertoire</tt> », l'url à utiliser dans l'option '''commit_to'''. Dans cet exemple :
* Les répertoires « <tt>/app/ezpublish/extension</tt> » et « <tt>/app/ezpublish/settings</tt> » sont gérés par le référentiel '''nfs'''.
* Le reste de « <tt>/app/ezpublish</tt> » est géré par le référentiel '''base'''.

Le chapitre consacré aux [[FSVS_Configuration_et_Utilisation#Liste_des_arborescences_sp.C3.A9ciales_plate-forme_par_plate-forme|référentiels spéciaux]] donne plus d'information sur les cas d'usage du multi-référentiel.

===== Exemple de commit =====

 fsvs commit -o commit_to=local -m "Commit des fichiers locaux" hostname network

<pre>
Committing to file:///usr/src/FSVS/repos/machines/M0379/etc
N... 14 hostname
N... dir network
N... dir network/if-down.d
N... 32 network/if-down.d/wpasupplicant
N... dir network/if-post-down.d
N... 32 network/if-post-down.d/wpasupplicant
N... 23 network/if-post-down.d/avahi-daemon
N... 997 network/if-post-down.d/wireless-tools
N... dir network/if-pre-up.d
N... 32 network/if-pre-up.d/wpasupplicant
N... 2280 network/if-pre-up.d/wireless-tools
N... dir network/if-up.d
N... 313 network/if-up.d/ntp
N... 32 network/if-up.d/wpasupplicant
N... 3726 network/if-up.d/mountnfs
N... 261 network/if-up.d/avahi-daemon
N... 462 network/if-up.d/ntpdate
N... 277 network/interfaces
N... dir network/run
N... 16 network/run/ifstate
committed revision 2 on 2008-10-02T15:54:31.658913Z as root
</pre>

==== Ignorer un fichier ====

Avec la commande suivante, on ignore :
* 2 fichiers à la racine du répertoire versionné
* Tous les fichiers se finissant par '~' dans toute l'arborescence
* Tous les fichiers et ''devices'' spéciaux (y compris les points de montage)

 fsvs ignore ./.pwd.lock ./mtab './**~' DEVICE:0

Liste des fichiers ignorés :

 fsvs ignore dump -v

Pour plus d'information, consulter http://doc.fsvs-software.org/doxygen-gif/group__ignpat.html

==== Enlever un fichier du référentiel ====

 fsvs unversion ld.so.cache

 d... 82032 ld.so.cache

 fsvs ignore ./ld.so.cache
 fsvs commit -m "on enlève ld.so.cache du référentiel" ld.so.cache

==== Supprimer un élément de l'ignore list ====

Pour l'instant ce n'est faisable qu'en enlevant et rechargeant toute la liste, sauf l'élément à enlever :

 fsvs ignore dump | grep -v "settings" | fsvs ignore load

==== Réparation du référentiel, resynchronisation ====

 fsvs sync-repos

Résout une désynchronisation entre le référentiel et la copie de travail '''sans modifier aucun fichier en local'''.

==== Trouver à quel référentiel appartient un élément ====

 fsvs info chemin_fichier_ou_repertoire

Regarder le champ '''URL'''.

==== Manipulation de la liste des urls ====

* Affiche le(s) référentiel(s) utilisé(s) :

 fsvs urls dump

 N:local,P:200,svn://10.10.2.44/system/prod/machines/ezpstatlog/trunk/etc

* Modifie le(s) référentiel(s) :

 (echo 'N:local,P:100,svn://10.10.2.44/system/prod/machines/ezpstatlog/trunk/etc') | fsvs urls load

{{:Bouygues/Modèle Cadre |
titre = [[Image:Nuvola_apps_khelpcenter.png|none|22px|Attention]] Ca casse la base existante car, ça remet le numéro de révision à 0 |
couleur = #FF8000 |
couleurTitre = #FF0000 |
contenu = 
The problem is that FSVS stores the current revision your WC is at (BASE in subversion-speak) along with the URL. If you dump that URL, and load it (or another) again, FSVS won't know which revision it is at locally - and use rev0. When you're trying to commit, FSVS tells the repository that it has changes against rev0 - but the repository answers "That's out of date! Somebody else committed 200 revisions in the mean time!". To get it working again, you'll have to tell FSVS which revision the WC is at; and the easiest way to do that is to run "<tt>fsvs sync-repos</tt>".
}}

